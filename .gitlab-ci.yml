stages: [lint, deploy]

default:
  tags: ["main"]

variables:
  # где хранить kubeconfig внутри job
  KUBECONFIG: "$CI_PROJECT_DIR/.kube/config"

.helm_base:
  image: alpine/helm:3.14.4
  before_script:
    - apk add --no-cache kubectl ca-certificates
    - test -n "$KUBECONFIG_B64" || (echo "KUBECONFIG_B64 is empty" && exit 2)
    - mkdir -p "$(dirname "$KUBECONFIG")"
    - echo "$KUBECONFIG_B64" | base64 -d > "$KUBECONFIG"
    - chmod 600 "$KUBECONFIG"
    - kubectl version --client=true
    - kubectl get ns
    - kubectl auth can-i --list -n dev

smoke_kube:
  stage: lint
  extends: .helm_base
  script:
    - echo "KUBECONFIG=$KUBECONFIG"
    - kubectl get ns
  rules: [ { if: '$CI_COMMIT_BRANCH' } ]

helm_lint:
  stage: lint
  extends: .helm_base
  script: [ "helm lint charts/myapp" ]
  rules: [ { if: '$CI_COMMIT_BRANCH' } ]

helm_deploy_dev:
  stage: deploy
  extends: .helm_base
  variables:
    HELM_RELEASE: ${HELM_RELEASE:-myapp}
    HELM_NAMESPACE: ${HELM_NAMESPACE:-dev}
    IMAGE_REPO: ${IMAGE_REPO:-192.168.0.10:5050/root/app}
    IMAGE_TAG: ${IMAGE_TAG:-latest}
  script:
    - kubectl get ns "$HELM_NAMESPACE" || kubectl create ns "$HELM_NAMESPACE"
    - >
      helm upgrade --install "$HELM_RELEASE" charts/myapp
      --namespace "$HELM_NAMESPACE"
      --set-string image.repository="$IMAGE_REPO"
      --set-string image.tag="$IMAGE_TAG"
      --atomic --wait --timeout 5m
  rules: [ { if: '$CI_COMMIT_BRANCH == "main"' } ]
